<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leitor | Ref칰gio Digital de Livros</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="font-serif bg-gray-100">

  <custom-reader-header></custom-reader-header>

  <div class="container mx-auto px-4 py-8 max-w-4xl flex">

    <!-- Sidebar -->
    <div class="hidden md:block w-64 pr-8">
      <div class="bg-white rounded-lg shadow-md p-4 sticky top-8">
        <h3 class="font-semibold text-gray-800 mb-3">Sum치rio</h3>
        <ul id="chapter-list" class="space-y-2"></ul>
        <div class="mt-6 pt-4 border-t border-gray-200" id="book-details"></div>
      </div>
    </div>

    <!-- Conte칰do Principal -->
    <div class="flex-1">
      <div class="bg-white rounded-lg shadow-lg p-8 md:p-12 mb-8">
        <div class="text-center mb-10">
          <h1 id="chapter-title" class="text-3xl font-bold text-gray-800 mb-2">Carregando cap칤tulo...</h1>
          <p id="book-info" class="text-gray-600"></p>
        </div>
        <div id="chapter-content" class="prose max-w-none text-gray-700">
          <p>Carregando conte칰do...</p>
        </div>
      </div>

      <div class="flex justify-between mb-8">
        <button id="prev-chapter" class="flex items-center text-gray-600 hover:text-indigo-600">
          <i data-feather="chevron-left" class="mr-2"></i> Cap칤tulo Anterior
        </button>
        <button id="next-chapter" class="flex items-center text-gray-600 hover:text-indigo-600">
          Pr칩ximo Cap칤tulo <i data-feather="chevron-right" class="ml-2"></i>
        </button>
      </div>

      <!-- Coment치rios -->
      <div class="bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">
          Coment치rios (<span id="comment-count">0</span>)
        </h2>
        <div id="comments-list" class="space-y-6 mb-8"></div>

        <div class="border-t border-gray-200 pt-6">
          <h3 class="font-medium text-gray-800 mb-4">Deixe um coment치rio</h3>
          <form id="comment-form">
            <textarea name="text" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mb-4" rows="4" placeholder="Compartilhe seus pensamentos..."></textarea>
            <input type="text" name="userName" placeholder="Seu nome (opcional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mb-4">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
              Publicar Coment치rio
            </button>
          </form>
        </div>
      </div>
    </div>

  </div>

  <custom-footer></custom-footer>

  <script src="components/navbar.js"></script>
  <script src="components/footer.js"></script>
  <script src="components/reader-header.js"></script>

  <script src="components/navbar.js"></script>
  <script src="components/footer.js"></script>
  <script src="components/reader-header.js"></script>

  <script>
   feather.replace();

// 游늷 Captura par칙metros da URL
const urlParams = new URLSearchParams(window.location.search);
const bookId = urlParams.get('id');
let chapterIndex = 0; // 칤ndice do cap칤tulo atualmente exibido

const chapterList = document.getElementById('chapter-list'); // sum치rio lateral (opcional)
const chapterTitle = document.getElementById('chapter-title');
const chapterContent = document.getElementById('chapter-content');
const commentsList = document.getElementById('comments-list');
const commentCount = document.getElementById('comment-count');
const commentForm = document.getElementById('comment-form');

// 游댳 Livro global
let book = null;

// 游댳 Carregar livro e cap칤tulos
async function loadBook() {
  try {
    const res = await fetch('/livros.json');
    const livros = await res.json();
    book = livros.find(l => l.id === bookId);

    if (!book) {
      chapterTitle.textContent = "Livro n칚o encontrado";
      return;
    }

    // 游댳 Renderiza sum치rio (opcional)
    chapterList.innerHTML = "";
    book.chapters.forEach((ch, index) => {
      const li = document.createElement('li');
      li.innerHTML = `<a href="#" data-index="${index}" class="text-gray-600 hover:text-indigo-600">${ch.title}</a>`;
      chapterList.appendChild(li);
    });

    // Clique no sum치rio
    chapterList.querySelectorAll("a").forEach(a => {
      a.addEventListener("click", e => {
        e.preventDefault();
        chapterIndex = Number(a.dataset.index);
        renderChapter();
      });
    });

    // Renderiza o primeiro cap칤tulo (ou o cap칤tulo indicado na URL)
    const urlCapIndex = Number(urlParams.get('cap'));
    if (!isNaN(urlCapIndex) && urlCapIndex >= 0 && urlCapIndex < book.chapters.length) {
      chapterIndex = urlCapIndex;
    }

    renderChapter();
  } catch (err) {
    console.error("Erro ao carregar livro:", err);
    chapterTitle.textContent = "Erro ao carregar o livro";
  }
}

// 游댳 Renderiza cap칤tulo atual + coment치rios
function renderChapter() {
  if (!book || !book.chapters[chapterIndex]) return;

  const ch = book.chapters[chapterIndex];
  chapterTitle.textContent = ch.title;
  chapterContent.innerHTML = `<p>${ch.content.replace(/\n/g, "<br>")}</p>`;

  // Atualiza coment치rios
  loadComments(ch.id);
}

// 游댳 Navega칞칚o por bot칫es
document.getElementById("prev-chapter").addEventListener("click", () => {
  if (chapterIndex > 0) {
    chapterIndex--;
    renderChapter();
  }
});
document.getElementById("next-chapter").addEventListener("click", () => {
  if (book && chapterIndex < book.chapters.length - 1) {
    chapterIndex++;
    renderChapter();
  }
});

// 游댳 Carregar coment치rios de um cap칤tulo
async function loadComments(chapterId) {
  try {
    const res = await fetch(`/comentarios/${book.id}/${chapterId}`);
    const data = await res.json();

    commentsList.innerHTML = "";
    data.forEach(comment => {
      const div = document.createElement('div');
      div.className = "flex space-x-4";
      div.innerHTML = `
        <div class="flex-shrink-0">
          <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
            <i data-feather="user" class="text-gray-500"></i>
          </div>
        </div>
        <div>
          <div class="flex items-center mb-1">
            <h4 class="font-medium text-gray-800 mr-2">${comment.userName || 'An칪nimo'}</h4>
            <span class="text-xs text-gray-500">${new Date(comment.createdAt).toLocaleDateString()}</span>
          </div>
          <p class="text-gray-700">${comment.text}</p>
        </div>
      `;
      commentsList.appendChild(div);
    });

    commentCount.textContent = data.length;
    feather.replace();
  } catch (err) {
    console.error("Erro ao carregar coment치rios:", err);
  }
}

// 游댳 Enviar novo coment치rio
commentForm.addEventListener("submit", async e => {
  e.preventDefault();
  const formData = new FormData(commentForm);
  const text = formData.get("text");
  const userName = formData.get("userName") || "An칪nimo";

  if (!text.trim()) return alert("Coment치rio n칚o pode estar vazio.");

  try {
    const res = await fetch(`/comentarios.json/${book.id}/${book.chapters[chapterIndex].id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text, userName })
    });

    if (!res.ok) throw new Error("Erro ao enviar coment치rio");

    commentForm.reset();
    loadComments(book.chapters[chapterIndex].id);
  } catch (err) {
    console.error(err);
    alert("Erro ao enviar coment치rio.");
  }
});

// 游댳 Inicializa
loadBook();


  </script>
</body>
</html>
